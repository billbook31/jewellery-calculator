<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Jewellery Calculator | Calculate Price Easily</title>
<meta name="description" content="Use this Gold Jewellery Calculator to quickly calculate the price of gold jewellery. Accurate, fast, and free.">
<meta name="keywords" content="gold calculator, jewellery price calculator, gold price, jewellery calculator, gold rate">
<meta name="robots" content="index, follow">
<meta name="language" content="English">
<meta name="author" content="BillBook">

<!-- Open Graph / Facebook Meta Tags -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://gold-jewellery-calculator.netlify.app/">
<meta property="og:title" content="Gold Jewellery Calculator">
<meta property="og:description" content="Calculate Gold Jewellery Price Quickly and Easily. Free Tool.">
<meta property="og:image" content="https://gold-jewellery-calculator.netlify.app/images/preview.png">

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Gold Jewellery Calculator">
<meta name="twitter:description" content="Calculate Gold Jewellery Price Quickly and Easily. Free Tool.">
<meta name="twitter:image" content="https://gold-jewellery-calculator.netlify.app/images/preview.png">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<style>
body { font-family:'Poppins',sans-serif; background:#f5f6fa; margin:0; color:#222; }
header { background:#ffd700; padding:15px; text-align:center; font-weight:bold; font-size:24px; }
.container { max-width:750px; margin:15px auto; background:#fff; padding:15px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
label { display:block; margin-top:8px; font-weight:600; }
input, select, textarea { width:100%; padding:8px; margin-top:4px; border-radius:6px; border:1px solid #ccc; }
button { background:#ffd700; border:none; padding:10px 15px; margin-top:12px; border-radius:6px; font-weight:bold; cursor:pointer; }
button.secondary { background:#eee; }
.flex { display:flex; gap:8px; flex-wrap:wrap; }
.flex > div { flex:1; }
.flex-center { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-top:15px; }
#billPreview { margin-top:15px; background:#fff3cd; padding:10px; border-radius:8px; }
.item-actions button { margin-right:5px; padding:6px 10px; }
.ad-section { background:#e0f7fa; text-align:center; border-radius:8px; padding:12px; margin:15px 0; font-weight:bold; font-size:16px; border:2px dashed #00bcd4; width:100%; height:50px; line-height:50px; }
.carat-flex { display:flex; gap:8px; margin-top:5px; }
.carat-flex > div { flex:1; }
/* Styles for Local Jewellers Showcase */
.showcase-container {
  display: flex;
  flex-wrap: wrap; /* Allows cards to wrap to multiple lines */
  gap: 15px; /* Space between cards */
  padding: 10px;
  background: #f0f0f0;
  border-radius: 8px;
}
.jeweller-card { display: inline-block; vertical-align: top; width: 250px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); padding: 15px; white-space: normal; cursor: pointer; transition: transform 0.2s ease; flex-shrink: 0; }
.jeweller-card:hover { transform: translateY(-5px); }
.jeweller-card.featured {
  transform: scale(1.05); /* Make featured card bigger */
  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6); /* Add a golden glow */
  border: 2px solid #ffd700;
}
.ad-card {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 250px;
  height: 200px; /* Adjust height to match jeweller cards */
  background: #e0f7fa;
  border: 2px dashed #00bcd4;
  border-radius: 10px;
  font-weight: bold;
  color: #00838f;
  flex-shrink: 0;
}
.jeweller-card img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto 10px; }
.jeweller-card h4 { margin: 0 0 5px 0; text-align: center; color: #b8860b; display: flex; justify-content: center; align-items: center; gap: 5px; }
.jeweller-card p { font-size: 12px; margin: 2px 0; }
.jeweller-card .social-links a { margin-right: 8px; text-decoration: none; font-size: 16px; }
.catalogue-strip { display: flex; gap: 5px; overflow-x: auto; padding-top: 10px; margin-top: 10px; border-top: 1px solid #eee; }
.catalogue-strip img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer; }
.lightbox { display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
.lightbox img { max-width: 90%; max-height: 90%; }
.lightbox .close-lightbox { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
.verified-badge { color: #1DA1F2; font-size: 16px; }
.jeweller-actions { display: flex; justify-content: space-around; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
.action-button { background: none; border: 1px solid #ddd; padding: 5px 8px; border-radius: 5px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 3px; }
.action-button:hover { background: #f0f0f0; }

/* Review Modal Styles */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1000; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  justify-content: center;
  align-items: center;
}
.modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; position: relative; }
.close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; right: 15px; top: 5px; }
.close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
.modal-content textarea { width: calc(100% - 16px); margin-top: 10px; margin-bottom: 10px; }
.modal-content button { width: 100%; }
.live-toggle { display: flex; align-items: center; margin-top: 10px; }
.live-toggle label { margin: 0 0 0 5px; font-weight: normal; }
.hidden { display: none; }
</style>
<style> /* Additional styles for anchor tags to look like buttons */
  .flex a.button-link { background:#ffd700; border:none; padding:10px 15px; margin-top:12px; border-radius:6px; font-weight:bold; cursor:pointer; text-decoration:none; color:#222; text-align:center; display:block; }
  .flex a.button-link:hover { background:#ffc107; } /* Slightly darker on hover */
</style>
<!-- 1. Include the jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- 2. Include Firebase libraries -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script> <!-- Firebase App Core -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script> <!-- Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script> <!-- Auth (for consistency) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script> <!-- Analytics (for consistency) -->
<script src="firebase-init.js"></script> <!-- Your centralized Firebase config -->

<!-- 4. Chart.js for price charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>

<header>üíé Jewellery Calculator</header>
<div class="container" style="text-align: center; padding: 10px;">
  <label style="font-weight: bold; margin-bottom: 5px;">üìç Find Local Jewellers by Location:</label>
  <div class="flex" style="justify-content: center; align-items: flex-end;">
      <div style="flex-basis: 40%;">
          <label for="stateInput" style="font-weight: normal; font-size: 12px; margin-top: 0;">State</label>
          <input type="text" id="stateInput" placeholder="e.g., Maharashtra">
      </div>
      <div style="flex-basis: 40%;"><label for="cityInput" style="font-weight: normal; font-size: 12px; margin-top: 0;">City</label><input type="text" id="cityInput" placeholder="e.g., Mumbai"></div>
      <button onclick="filterJewellersByLocation()" style="flex-basis: 15%; height: 36px;">Search</button>
  </div>
</div>


<div class="ad-section" id="topAd" style="height:auto; padding:0; line-height: normal; border: none; background: none; min-height: 50px;">
  <!-- 
    This section will be dynamically filled with a video from the dashboard 
    or an AdSense ad as a fallback.
   -->
</div>

<div class="container">
<h3>City Gold Rates (per gram)</h3>
  <label>Mumbai (24K)</label>
  <input type="number" id="rateMumbai" readonly placeholder="Loading today's rate...">
</div>

<div class="container">
<h3>Gold Rate (per gram)</h3>
<label>24K Rate</label>
<input type="number" id="rate24" value="7200" oninput="updateCaratRates()" min="0">

<div class="carat-flex">
  <div><label>24K</label><input type="number" id="rate24k" readonly></div>
  <div><label>23K</label><input type="number" id="rate23" readonly></div>
  <div><label>22K</label><input type="number" id="rate22" readonly></div>
</div>
<div class="carat-flex">
  <div><label>20K</label><input type="number" id="rate20" readonly></div>
  <div><label>18K</label><input type="number" id="rate18" readonly></div>
  <div><label>14K</label><input type="number" id="rate14" readonly></div>
  <div><label>9K</label><input type="number" id="rate9" readonly></div>
</div>

<div style="margin-top: 15px;">
  <h4>Price Trend (Last 7 Days)</h4>
  <canvas id="goldPriceChart"></canvas>
</div>
</div>

<div class="container">
<h3>Silver Rate (per gram)</h3>
<div class="flex" oninput="updateSilverRate()">
  <div><label>99.99% Rate</label><input type="number" id="silverPure" value="80" min="0"></div>
  <div><label>Custom %</label><input type="number" id="silverPercent" placeholder="Enter %" min="0"></div>
  <div><label>Calculated Rate</label><input type="number" id="silverCalc" readonly min="0"></div>
</div>

<div class="ad-section" id="silverAd" style="height:100px;">
  <!-- Paste your AdSense ad unit code here -->
  * Silver Ad: Latest Market Rates *
</div>
</div>

<div class="container">
<h3>Jewellery Billing</h3>
<label>Item Name</label>
<input id="itemName" placeholder="e.g. Necklace, Ring">

<label>Type</label>
<select id="itemType" onchange="setDefaultCarat()">
  <option value="gold">Gold</option>
  <option value="silver">Silver</option>
</select>

<label>Carat / %</label>
<select id="carat">
  <option value="24">24K</option>
  <option value="23">23K</option>
  <option value="22">22K</option>
  <option value="20">20K</option>
  <option value="18">18K</option>
  <option value="14">14K</option>
  <option value="9">9K</option>
</select>

<label>Weight (grams)</label>
<input type="number" id="weight" value="1" step="0.01">

<label>Making Charge</label>
<input type="number" id="makingValue" value="100" min="0">

<select id="makingType">
  <option value="pergram">‚Çπ/gram</option>
  <option value="percent">%</option>
</select>

<label>Nagina / Diamond Cost (Optional)</label>
<input type="number" id="stoneCost" value="0" min="0">

<label>GST (%)</label>
<input type="number" id="gst" value="3" min="0">
</div>

<hr>
<h4>Old Jewellery</h4>
<label>Total Weight</label><input type="number" id="oldWeight" value="0" step="0.01" min="0">
<label>Jalan Weight</label><input type="number" id="oldJalan" value="0" step="0.01" min="0">
<label>Manual Rate</label><input type="number" id="oldRate" value="0" step="0.01" min="0">

<div class="flex-center">
<button onclick="addItem()">Add Item</button>
<button onclick="addToWishlist()" class="secondary">‚ù§Ô∏è Add to Wishlist</button>
<button onclick="newBill()" class="secondary">New Bill</button>
<button onclick="saveBill()">Save & Print</button>
<button onclick="shareWhatsApp()">WhatsApp Share</button>
<button onclick="exportPDF()" class="secondary">Export as PDF</button>
<button onclick="showHistory()">Bill History</button>
</div>

<div id="historyPreview" class="container" style="display:none; margin-top: 15px;"></div>

<div id="wishlistPreview" class="container" style="display:none; margin-top: 15px;"></div>

<div class="ad-section" id="billAd" style="height:150px;">
  <!-- Paste your AdSense ad unit code here -->
  * Bill Total Ad: Earn Loyalty Points! *
</div>

<div id="billPreview"></div>

<div class="container">
<h3>Customer Review</h3>
<textarea id="starReview" rows="3" placeholder="Write your review here..."></textarea>
<button onclick="submitReview()">Submit Feedback</button>

<div class="ad-section" id="reviewAd" style="height:150px;">
  <!-- Paste your AdSense ad unit code here -->
  * Review Section Ad: Get Discounts on Next Purchase! *
</div>
</div>

<div class="container" id="jewellerActions">
  <h3>Are you a Jeweller?</h3>
  <p>List your shop on our calculator for free and reach thousands of customers. Manage your profile and see how many users view your shop.</p>
  <div class="flex-center">
    <a href="shop-register.html" class="button-link" style="background-color: #28a745; color: white;">Register / Manage Your Shop</a>
    <a href="jeweller-dashboard.html" class="button-link secondary">View Your Dashboard</a>
  </div>
  <input type="hidden" id="shopDocId">
</div>
 
<div class="container">
  <h3>üí∞ Investment Options</h3>
  <div class="flex">
    <button onclick="alert('Gold ETF')">Gold ETF</button>
    <button onclick="alert('Sovereign Gold Bond')">Sovereign Gold Bond</button>
    <button onclick="alert('Physical Coin / Bar')">Physical Coin / Bar</button>
    <button onclick="alert('Digital Gold')">Digital Gold</button>
  </div>
</div>

<div class="container">
  <h3>üìÇ Additional Tools & Pages</h3>
  <div class="flex">
    <a href="dashboard.html" class="button-link">üìä Dashboard</a>
    <a href="blog.html" class="button-link">üì∞ Blog</a>
    <a href="help.html" class="button-link">‚ùì Help</a>
    <a href="about.html" class="button-link">üë§ About Us</a>
    <a href="terms.html" class="button-link">üìÑ Terms & Conditions</a>
    <a href="privacy.html" class="button-link">üîí Privacy Policy</a>
  </div>
</div>

<div class="container">
  <h3>üìç Local Jewellers Showcase</h3>
  <p>Find trusted jewellers near you. (Side-scroll to see more)</p>
  <div id="jewellersShowcase" class="showcase-container">
    <!-- Jeweller cards will be loaded here by JavaScript -->
  </div>
</div>

<!-- Shop Review Modal -->
<div id="shopReviewModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeReviewModal()">&times;</span>
    <h3>Review <span id="reviewShopName" style="color: #b8860b;"></span></h3>
    <p>Share your experience with this jeweller.</p>
    <textarea id="shopReviewText" rows="4" placeholder="Write your review here..."></textarea>
    <button onclick="submitShopReview()">Submit Review</button>
    <input type="hidden" id="currentReviewShopId">
  </div>
</div>

<!-- Lightbox for Catalogue Images -->
<div id="imageLightbox" class="lightbox" onclick="closeLightbox()">
  <span class="close-lightbox">&times;</span>
  <img id="lightboxImage" src="">
</div>

<script>
let items=[];
let billsHistory=[];
let wishlist = [];

// FIX: Old Jewellery logic change to ensure deduction happens on grand total
let oldJewellery = {weight: 0, jalan: 0, rate: 0, total: 0};

function updateCaratRates(){
  let rate24=parseFloat(document.getElementById('rate24').value)||0;
  document.getElementById('rate24k').value=rate24.toFixed(2);
  document.getElementById('rate23').value=(rate24*23/24).toFixed(2);
  document.getElementById('rate22').value=(rate24*22/24).toFixed(2);
  document.getElementById('rate20').value=(rate24*20/24).toFixed(2);
  document.getElementById('rate18').value=(rate24*18/24).toFixed(2);
  document.getElementById('rate14').value=(rate24*14/24).toFixed(2);
  document.getElementById('rate9').value=(rate24*9/24).toFixed(2);
}

function updateSilverRate(){
  let pure=parseFloat(document.getElementById('silverPure').value)||0;
  let pct=parseFloat(document.getElementById('silverPercent').value)||0;
  // If no custom percentage is entered, use 100% (the pure rate) as the calculated rate.
  let finalRate = (pct > 0) ? (pure * pct / 100) : pure;
  document.getElementById('silverCalc').value = finalRate.toFixed(2);
}

function setDefaultCarat(){
  let type=document.getElementById('itemType').value;
  document.getElementById('carat').value=type==='gold'?'24':'';
}

function addItem(){
  let type=document.getElementById('itemType').value;
  let itemName=document.getElementById('itemName').value||'Jewellery Item';
  let carat=document.getElementById('carat').value;
  let weight=parseFloat(document.getElementById('weight').value)||0;
  let makingVal=parseFloat(document.getElementById('makingValue').value)||0;
  let makingType=document.getElementById('makingType').value;
  let gst=parseFloat(document.getElementById('gst').value)||0;
  let stoneCost = parseFloat(document.getElementById('stoneCost').value) || 0;
  
  let rate=0;
  if(type==='gold') rate=parseFloat(document.getElementById('rate'+carat).value)||0;
  else if(type==='silver') rate=parseFloat(document.getElementById('silverCalc').value)||0;
  
  let baseAmount=rate*weight;
  let makingCharge = (makingType === 'pergram') ? makingVal * weight : (baseAmount * makingVal / 100);
  let subtotal=baseAmount+makingCharge+stoneCost;
  let gstAmt=subtotal*gst/100;
  let total=subtotal+gstAmt;
  // FIX: Old Jewellery details ko global object mein save karein, item mein nahi
  oldJewellery.weight=parseFloat(document.getElementById('oldWeight').value)||0;
  oldJewellery.jalan=parseFloat(document.getElementById('oldJalan').value)||0;
  oldJewellery.rate=parseFloat(document.getElementById('oldRate').value)||0;
  
  // FIX: Save original making charge values for editing
  items.push({itemName,type,carat,weight,rate,makingCharge,stoneCost,subtotal,gstAmt,total, makingValue: makingVal, makingType: makingType});
  // Clear input fields after adding an item for better UX
  document.getElementById('itemName').value = '';
  document.getElementById('weight').value = '1';
  document.getElementById('stoneCost').value = '0';
  renderBill();
}

function addToWishlist() {
    const itemName = document.getElementById('itemName').value || 'Jewellery Item';
    const weight = parseFloat(document.getElementById('weight').value) || 0;
    if (weight <= 0) {
        alert('Please enter a valid weight to add to wishlist.');
        return;
    }
    wishlist.push({
        itemName: itemName,
        type: document.getElementById('itemType').value,
        carat: document.getElementById('carat').value,
        weight: weight
    });
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
    renderWishlist();
    alert(`'${itemName}' has been added to your wishlist!`);
}

function renderWishlist() {
    const wishlistDiv = document.getElementById('wishlistPreview');
    if (wishlist.length === 0) {
        wishlistDiv.style.display = 'none';
        return;
    }
    let html = '<h3>‚ù§Ô∏è My Wishlist</h3>';
    wishlist.forEach((item, idx) => {
        html += `<p>${item.itemName} (${item.weight}g, ${item.carat}) <button onclick="deleteFromWishlist(${idx})">Remove</button></p>`;
    });
    wishlistDiv.innerHTML = html;
    wishlistDiv.style.display = 'block';
}

function deleteFromWishlist(idx) {
    wishlist.splice(idx, 1);
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
    renderWishlist();
}

function renderBill(){
  let html='';
  let grandTotal=0;
  let oldTotal=0;
  
  // 1. New Items ka Total
  items.forEach((i,idx)=>{
    grandTotal+=i.total;
    html += `<b>Item ${idx+1}:</b> ${i.itemName} (${i.type})<br>
             Carat/%: ${i.carat}<br>
             Weight: ${i.weight} gm<br>
             Rate/gm: ‚Çπ${i.rate.toFixed(2)}<br>` +
             (i.stoneCost > 0 ? `Nagina/Stone Cost: ‚Çπ${i.stoneCost.toFixed(2)}<br>` : '') +
             `Making: ‚Çπ${i.makingCharge.toFixed(2)}, Subtotal: ‚Çπ${i.subtotal.toFixed(2)}, GST: ‚Çπ${i.gstAmt.toFixed(2)}, Total: ‚Çπ${i.total.toFixed(2)}<br>
             <div class="item-actions"><button onclick="editItem(${idx})">Edit</button><button onclick="deleteItem(${idx})">Delete</button></div><hr>`;
  });
  
  let deductionText = '';
  
  // 2. Old Jewellery Deduction (Grand Total par lagao)
  if(oldJewellery.weight>0 && oldJewellery.rate>0){
    let netWeight=oldJewellery.weight-oldJewellery.jalan;
    oldTotal=netWeight*oldJewellery.rate;
    grandTotal -= oldTotal;
    deductionText += `<p style="color:red; font-weight:bold;">Old Jewellery Deduction (Net Weight: ${(netWeight).toFixed(2)}g): - ‚Çπ${oldTotal.toFixed(2)}</p>`;
    oldJewellery.total = oldTotal; // Store the calculated total for print/share
  }

  // 3. Final Display
  html += `<h3>New Items Subtotal: ‚Çπ${(grandTotal+oldTotal).toFixed(2)}</h3>`;
  html += deductionText;
  html += `<h2>Grand Total Payable: ‚Çπ${grandTotal.toFixed(2)}</h2>`;
  document.getElementById('billPreview').innerHTML=html;
}


// --- REST OF THE FUNCTIONS (Cleaned & Fixed for Local Storage/Sharing) ---

function editItem(idx){
  let i=items[idx];
  document.getElementById('itemName').value=i.itemName;
  document.getElementById('itemType').value=i.type;
  document.getElementById('weight').value=i.weight;
  document.getElementById('gst').value = i.subtotal > 0 ? (i.gstAmt / i.subtotal * 100).toFixed(2) : 0; // Calculate back the GST percentage
  document.getElementById('makingValue').value = i.makingValue; // Restore original making value from the item object
  document.getElementById('makingType').value = i.makingType; // Restore original making type
  document.getElementById('stoneCost').value = i.stoneCost || 0;

  setDefaultCarat(); // Ensure carat dropdown is correct for the item type
  document.getElementById('carat').value=i.carat; // Set carat after type is set
  items.splice(idx,1);
  renderBill();
}

function deleteItem(idx){
  items.splice(idx,1);
  renderBill();
}

function newBill(){
  // Save the current bill to history before starting a new one
  if(items.length>0) {
    let billToSave = { items: JSON.parse(JSON.stringify(items)), old: JSON.parse(JSON.stringify(oldJewellery)) };
    billsHistory.push(billToSave);
    localStorage.setItem('billsHistory', JSON.stringify(billsHistory)); // Update local storage
  }
  items=[];
  oldJewellery = {weight: 0, jalan: 0, rate: 0, total: 0}; // Reset Old Jewellery
  // Optional: Reset old jewellery input fields
  document.getElementById('oldWeight').value = 0;
  document.getElementById('oldJalan').value = 0;
  document.getElementById('oldRate').value = 0;
  renderBill();
}

function saveBill(){
  if(items.length===0){ alert('Add items first'); return; }
  
  // Save the current bill to history
  let billToSave = { items: JSON.parse(JSON.stringify(items)), old: JSON.parse(JSON.stringify(oldJewellery)) };
  billsHistory.push(billToSave);
  localStorage.setItem('billsHistory', JSON.stringify(billsHistory));

  // REFACTOR: Log bill to Firestore for global analytics
  const newItemsTotal = items.reduce((acc, i) => acc + i.total, 0);
  const oldItemsTotal = oldJewellery.total || 0;
  db.collection('analytics_bills').add({
      newItemsValue: newItemsTotal,
      oldDeductionValue: oldItemsTotal,
      grandTotal: newItemsTotal - oldItemsTotal,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  
  printBill();
  alert('Bill saved!');
}

function printBill(){
  let win=window.open('', '_blank');
  // FIX: Removed reference to non-existent 'shopName' element to prevent errors.
  let shopName=localStorage.getItem('shopName') || 'Jewellery Shop';
  let shopAddress=localStorage.getItem('shopAddress') || '';
  let customerName=prompt('Enter Customer Name','Customer')||'Customer';
  let shopGST=localStorage.getItem('shopGST') || '';
  let shopContact=localStorage.getItem('shopContact') || '';
  let billDate=new Date().toLocaleDateString();
  
  win.document.write(`<h1 style="text-align:center">${shopName}</h1>`);
  if(shopAddress) win.document.write(`<p style="text-align:center">${shopAddress}</p>`);
  if(shopContact || shopGST) win.document.write(`<p style="text-align:center">Contact: ${shopContact} | GSTIN: ${shopGST}</p>`);
  win.document.write(`<p style="text-align:center">Customer: ${customerName} | Date: ${billDate}</p><hr>`);
  win.document.write(document.getElementById('billPreview').innerHTML);
  win.print();
}

function shareWhatsApp(){
  if(items.length === 0){ 
    alert('Bill mein koi item nahi hai.'); 
    return; 
  }

  let shopName = localStorage.getItem('shopName') || 'Jewellery Shop';
  let newItemsTotal = items.reduce((acc, i) => acc + i.total, 0);

  if (oldJewellery.weight > 0 && oldJewellery.rate > 0) {
      oldJewellery.total = (oldJewellery.weight - oldJewellery.jalan) * oldJewellery.rate;
  }

  let grandTotal = newItemsTotal - (oldJewellery.total || 0);

  let billText = `*${shopName} Bill Details*\n\n`;
  billText += `*Customer:* ${prompt('Enter Customer Name for WhatsApp', 'Customer') || 'Customer'}\n\n`;
  items.forEach((item, index) => {
    if (item.stoneCost > 0) billText += `*Item ${index + 1}:* ${item.itemName} (+ Stone) - ${item.weight}g\n`; else
    billText += `*Item ${index + 1}:* ${item.itemName} (${item.type} ${item.carat}) - ${item.weight}g\n`;
    billText += `  Total: ‚Çπ${item.total.toFixed(2)}\n\n`;
});
  billText += `*New Items Total:* ‚Çπ${newItemsTotal.toFixed(2)}\n`;
  billText += `*Old Jewellery Deduction:* - ‚Çπ${(oldJewellery.total || 0).toFixed(2)}\n\n`;
  billText += `*Grand Total Payable:* ‚Çπ${grandTotal.toFixed(2)}\n`;

  let url = "https://wa.me/?text=" + encodeURIComponent(billText);
  window.location.href = url;

  // REFACTOR: Log WhatsApp share event to Firestore
  db.collection('analytics_events').add({ type: 'whatsapp_share', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
}

function showHistory(){
  let history = JSON.parse(localStorage.getItem('billsHistory')) || [];
  let historyDiv = document.getElementById('historyPreview');
  
  if (history.length === 0) {
    alert('No bills saved yet.');
    return;
  }

  let historyHtml = '<h3>Bill History</h3>';
  history.forEach((b,i)=>{
    let totalItemsValue = b.items.reduce((acc, itm) => acc + itm.total, 0);
    let finalTotal = totalItemsValue - (b.old.total || 0);

    historyHtml += `<p><b>Bill ${i+1}:</b> Items Total: ‚Çπ${totalItemsValue.toFixed(2)};`;
    if(b.old.total > 0) historyHtml += ` | Deduction: ‚Çπ${b.old.total.toFixed(2)}`;
    historyHtml += ` | <b>Final Total: ‚Çπ${finalTotal.toFixed(2)}</b></p><hr>`;
  });
  historyDiv.innerHTML = historyHtml;
  historyDiv.style.display = 'block';
}

function exportPDF() {
  if (items.length === 0) {
    alert('Cannot export an empty bill. Please add items first.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20; // Y-position cursor

  // --- Shop Details ---
  const shopName = localStorage.getItem('shopName') || 'Jewellery Shop';
  const shopAddress = localStorage.getItem('shopAddress') || '';
  const shopContact = localStorage.getItem('shopContact') || '';
  const shopGST = localStorage.getItem('shopGST') || '';

  // --- Customer Name ---
  let customerName = prompt('Enter Customer Name for PDF', 'Customer') || 'Customer';
  let billDate = new Date().toLocaleDateString();

  doc.setFontSize(20).setFont(undefined, 'bold');
  doc.text(shopName, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
  y += 8;
  doc.setFontSize(10).setFont(undefined, 'normal');
  if (shopAddress) {
    doc.text(`${shopAddress}`, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
    y += 5;
  }
  if (shopContact) {
    doc.text(`Contact: ${shopContact} | GSTIN: ${shopGST}`, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
    y += 5;
  }
  y += 5;
  doc.line(10, y, 200, y); // Horizontal line
  y += 10;

  // --- Bill Items ---
  doc.setFontSize(12).setFont(undefined, 'bold');
  doc.text('Bill Details', 10, y);
  y += 7;
  doc.setFontSize(10).setFont(undefined, 'normal');
  let newItemsTotal = 0;
  items.forEach((i, idx) => {
    doc.text(`Item ${idx + 1}: ${i.itemName} (${i.type}, ${i.carat}) - ${i.weight}g @ ‚Çπ${i.rate.toFixed(2)}/g`, 15, y); // Line 445
    doc.text(`‚Çπ${i.total.toFixed(2)}`, 195, y, { align: 'right' });
    y += 6;
    if (i.stoneCost > 0) {
      doc.setFontSize(9).setFont(undefined, 'italic');
      doc.text(`  (Includes Nagina/Stone Cost: ‚Çπ${i.stoneCost.toFixed(2)})`, 15, y);
      y += 5;
    }
    newItemsTotal += i.total;
  });

  y += 5;
  doc.line(10, y, 200, y); // Horizontal line
  y += 7;

  // --- Totals ---
  doc.setFontSize(12).setFont(undefined, 'bold');
  doc.text('New Items Total:', 15, y);
  doc.text(`‚Çπ${newItemsTotal.toFixed(2)}`, 195, y, { align: 'right' });
  y += 7;

  let grandTotal = newItemsTotal;

  if (oldJewellery.total > 0) {
    doc.setFont(undefined, 'normal');
    doc.text('Old Jewellery Deduction:', 15, y);
    doc.text(`- ‚Çπ${oldJewellery.total.toFixed(2)}`, 195, y, { align: 'right' });
    grandTotal -= oldJewellery.total;
    y += 7;
  }

  doc.setFont(undefined, 'bold');
  doc.text('Grand Total Payable:', 15, y);
  doc.text(`‚Çπ${grandTotal.toFixed(2)}`, 195, y, { align: 'right' });

  doc.save(`Bill-${shopName}-${new Date().toISOString().slice(0,10)}.pdf`);
}

// FIX: Initialize function theek kiya gaya hai
window.onload=function(){
  updateCaratRates();
  updateSilverRate();
  
  // 1. Bill History Load karna
  billsHistory = JSON.parse(localStorage.getItem('billsHistory')) || [];
  // 1b. Wishlist Load karna
  wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
  renderWishlist();
  
  // 2. Shop Details Load karna
  // 3. Fetch city gold rates
  fetchCityGoldRates();

  // REFACTOR: Log a visitor/app usage event to Firestore
  db.collection('analytics_events').add({ type: 'visitor', createdAt: firebase.firestore.FieldValue.serverTimestamp() });

  // Dynamically load configurations (AdSense and Top Ad Video)
  db.collection('config').doc('live').get().then(doc => {
      if (doc.exists) {
          const config = doc.data();
          const topAdContainer = document.getElementById('topAd');
          const videoUrl = config.topAdVideoUrl;

          // 1. Load Top Ad Video if URL exists
          if (videoUrl) {
              // Check if it's an Instagram URL
              if (videoUrl.includes('instagram.com')) {
                  // It's an Instagram Reel, use an iframe for embedding
                  // We need to add '/embed' to the URL and adjust styling
                  const embedUrl = videoUrl.split("?")[0] + 'embed';
                  topAdContainer.style.height = 'auto'; // Adjust container height
                  topAdContainer.innerHTML = `
                      <iframe src="${embedUrl}" width="320" height="580" style="border:none; overflow:hidden; border-radius: 8px; max-width: 100%;" scrolling="no" frameborder="0" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>
                  `;
              } else {
                  // It's a direct video link (e.g., .mp4), use the video tag
                  topAdContainer.innerHTML = `
                      <video width="100%" style="border-radius: 8px; display: block;" controls autoplay muted loop>
                          <source src="${videoUrl}" type="video/mp4">
                          Your browser does not support the video tag.
                      </video>`;
              }

          } 
          // 2. Fallback to AdSense if no video URL
          else if (config.adsense_client_id) {
              topAdContainer.innerHTML = `
                  <ins class="adsbygoogle" style="display:block" data-ad-client="${config.adsense_client_id}" data-ad-slot="YOUR_AD_SLOT_ID" data-ad-format="auto" data-full-width-responsive="true"></ins>`;
              (adsbygoogle = window.adsbygoogle || []).push({});
          }

          // 3. Load AdSense script (needed for fallback)
          const adsenseId = config.adsense_client_id;
          const script = document.createElement('script');
          script.async = true;
          script.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${adsenseId}`;
          script.crossOrigin = 'anonymous';
          document.head.appendChild(script);
          console.log('AdSense script loaded for client:', adsenseId);
      }
  });

  // 4. Load local jewellers showcase
  loadJewellersShowcase();
};

function filterJewellersByLocation() {
    const state = document.getElementById('stateInput').value.trim();
    const city = document.getElementById('cityInput').value.trim();
    localStorage.setItem('userState', state);
    localStorage.setItem('userCity', city);
    loadJewellersShowcase(); // Reload the showcase with the new filter
}

function renderGoldPriceChart(historicalData) {
    const ctx = document.getElementById('goldPriceChart').getContext('2d');
    const labels = historicalData.map(d => new Date(d.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }));
    const prices = historicalData.map(d => d.rate24k);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '24K Gold Price',
                data: prices,
                borderColor: '#ffd700',
                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
}



// Fetch city-specific gold rates from Firestore
async function fetchCityGoldRates() {
    // ‡§π‡§Æ‡§æ‡§∞‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ Netlify Function ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
    const functionUrl = `/.netlify/functions/get-gold-rate`;

    try {
        const response = await fetch(functionUrl); // 'await' requires an async function
        const data = await response.json();

        if (data && data.price && !data.error) {
            const pricePerOunce = data.price;
            // 1 Troy Ounce = 31.1035 ‡§ó‡•ç‡§∞‡§æ‡§Æ
            const pricePerGram = pricePerOunce / 31.1035;

            // ‡§Æ‡•Å‡§Ç‡§¨‡§à ‡§∞‡•á‡§ü ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            document.getElementById('rateMumbai').value = pricePerGram.toFixed(2);
            
            // ‡§ï‡•á‡§µ‡§≤ ‡§§‡§≠‡•Ä 24K ‡§∞‡•á‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§¨ ‡§µ‡§π ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§Æ‡§æ‡§® ‡§™‡§∞ ‡§π‡•ã, ‡§§‡§æ‡§ï‡§ø ‡§Ø‡•Ç‡§ú‡§∞ ‡§ï‡§æ ‡§á‡§®‡§™‡•Å‡§ü ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§® ‡§π‡•ã‡•§
            const rate24Input = document.getElementById('rate24');
            if (rate24Input.value === "7200" || rate24Input.value === "") { // ‡§ï‡•á‡§µ‡§≤ ‡§§‡§≠‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§¨ ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§Æ‡§æ‡§® ‡§π‡•ã
                rate24Input.value = pricePerGram.toFixed(2);
            }
            updateCaratRates(); // ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡•à‡§∞‡•á‡§ü ‡§∞‡•á‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§≠‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        } else {
            console.error("Error from Netlify function:", data.error || "Unknown error");
            document.getElementById('rateMumbai').value = 'Error';
        }
    } catch (error) {
        console.error("Error calling Netlify function: ", error);
        document.getElementById('rateMumbai').value = 'Error';
    }
    // Historical data for the chart
    // ‡§Ö‡§≠‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ö‡§æ‡§∞‡•ç‡§ü ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡§æ‡§∏ ‡§∏‡•Ä‡§ß‡•á API ‡§∏‡•á ‡§ê‡§§‡§ø‡§π‡§æ‡§∏‡§ø‡§ï ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§
    // ‡§á‡§∏‡•á ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§
    document.getElementById('goldPriceChart').style.display = 'none';
}

function loadJewellersShowcase() {
    const stateFilter = localStorage.getItem('userState') || '';
    const cityFilter = localStorage.getItem('userCity') || '';

    const showcaseDiv = document.getElementById('jewellersShowcase');

    let query = db.collection('registered_shops').where('isLive', '==', true);

    // Apply filters
    if (stateFilter) {
        query = query.where('state', '==', stateFilter);
    }
    if (cityFilter) {
        query = query.where('city', '==', cityFilter);
    }

    query.limit(20).onSnapshot(snapshot => {
        if (snapshot.empty) {
            if (!stateFilter && !cityFilter) {
                showcaseDiv.innerHTML = '<p>No live jewellers found. Be the first to register and go live!</p>';
            } else {
                showcaseDiv.innerHTML = `<p>No live jewellers found for <b>${cityFilter || ''} ${stateFilter || ''}</b>. Try a different location or clear the search.</p>`;
            }
            return;
        }

        let html = ''; let cardCount = 0;

        snapshot.forEach(doc => {
            const shop = doc.data();
            // Default DP if none provided
            const dpUrl = shop.dpUrl || 'https://via.placeholder.com/60';

            const featuredClass = shop.isFeatured ? 'featured' : '';
            const verifiedBadge = shop.isVerified ? '<span class="verified-badge" title="Verified Jeweller">‚úî</span>' : '';

            let catalogueHtml = '';
            if (shop.catalogueImages && shop.catalogueImages.length > 0) {
                catalogueHtml += '<div class="catalogue-strip">';
             shop.catalogueImages.forEach(item => {
                    if (item.type === 'image') {
                        catalogueHtml += `<img src="${item.url}" loading="lazy" onclick="event.stopPropagation(); openLightbox('${item.url}')">`;
                    } else if (item.type === 'video') {
                        catalogueHtml += `<video src="${item.url}" width="50" height="50"  muted loop onclick="event.stopPropagation(); openLightbox('${item.url}')"></video>`;

                    }

                });

                catalogueHtml += '</div>';
            }

            html += `
                <div class="jeweller-card ${featuredClass}" data-shop-id="${doc.id}" onclick="logProfileView('${doc.id}')">
                    <img src="${dpUrl}" alt="${shop.name || 'Jeweller'} DP" loading="lazy">
                    <h4>${shop.name || 'N/A'} ${verifiedBadge}</h4>
                    <p>üìç ${shop.city || ''}${shop.city && shop.state ? ', ' : ''}${shop.state || ''}</p>
                    <div class="social-links">
                        ${shop.insta ? `<a href="https://instagram.com/${shop.insta.replace(/@/g, '')}" target="_blank" onclick="event.stopPropagation()">üì∏</a>` : ''}
                        ${shop.fb ? `<a href="https://facebook.com/${shop.fb}" target="_blank" onclick="event.stopPropagation()">üìò</a>` : ''}
                        ${shop.website ? `<a href="${shop.website.startsWith('http') ? shop.website : 'https://' + shop.website}" target="_blank" onclick="event.stopPropagation()">üåê</a>` : ''}
                    </div>
                    <div class="jeweller-actions">
                        <button class="action-button" onclick="event.stopPropagation(); likeShop('${doc.id}')">‚ù§Ô∏è <span id="likes-${doc.id}">${shop.likesCount || 0}</span></button>
                        <button class="action-button" onclick="event.stopPropagation(); followShop('${doc.id}')">‚≠ê <span id="follows-${doc.id}">${shop.followsCount || 0}</span></button>
                        <button class="action-button" onclick="event.stopPropagation(); openReviewModal('${doc.id}', '${shop.name || 'this shop'}')">‚úçÔ∏è Review</button>
                    </div>
                    ${catalogueHtml}
                </div>
            `;
            cardCount++;
            // Insert an ad card after every 4 jeweller cards
            if (cardCount % 4 === 0) {
                html += `<div class="ad-card">
                           <!-- Paste your AdSense ad unit code here -->
                           Your Ad Here
                         </div>`;
            }
        });
        showcaseDiv.innerHTML = html;
    });
}

function logProfileView(shopId) {
    if (!shopId) return;
    // Increment the profileViews count for the specific shop
    db.collection('registered_shops').doc(shopId).update({
        profileViews: firebase.firestore.FieldValue.increment(1)
    }).catch(error => {
        console.error("Error logging profile view: ", error);
    });
}

function openLightbox(imageUrl) {
    document.getElementById('lightboxImage').src = imageUrl;
    document.getElementById('imageLightbox').style.display = 'flex';
}

function closeLightbox() {
    document.getElementById('imageLightbox').style.display = 'none';
    document.getElementById('lightboxImage').src = ''; // Clear image
}

async function likeShop(shopId) {
    if (!shopId) return;
    try {
        await db.collection('registered_shops').doc(shopId).update({
            likesCount: firebase.firestore.FieldValue.increment(1)
        });
        const likesSpan = document.getElementById(`likes-${shopId}`);
        if (likesSpan) likesSpan.innerText = parseInt(likesSpan.innerText) + 1;
    } catch (error) { console.error("Error liking shop: ", error); }
}

async function followShop(shopId) {
    if (!shopId) return;
    try {
        await db.collection('registered_shops').doc(shopId).update({
            followsCount: firebase.firestore.FieldValue.increment(1)
        });
        const followsSpan = document.getElementById(`follows-${shopId}`);
        if (followsSpan) followsSpan.innerText = parseInt(followsSpan.innerText) + 1;
    } catch (error) { console.error("Error following shop: ", error); }
}

function openReviewModal(shopId, shopName) {
    document.getElementById('currentReviewShopId').value = shopId;
    document.getElementById('reviewShopName').innerText = shopName;
    document.getElementById('shopReviewModal').style.display = 'flex';
}

function closeReviewModal() {
    document.getElementById('shopReviewModal').style.display = 'none';
    document.getElementById('shopReviewText').value = '';
}

async function submitShopReview() {
    const shopId = document.getElementById('currentReviewShopId').value;
    const reviewText = document.getElementById('shopReviewText').value.trim();
    if (!shopId || !reviewText) { alert('Please write a review.'); return; }
    await db.collection('reviews').add({
        shopId: shopId,
        content: reviewText,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('Review submitted successfully!');
    closeReviewModal();
}

function submitReview(){
  const reviewText = document.getElementById('starReview').value.trim();
  if (!reviewText) { alert('Please write a review before submitting.'); return; }
  db.collection('reviews').add({ content: reviewText, createdAt: firebase.firestore.FieldValue.serverTimestamp() })
    .then(() => {
      db.collection('analytics_events').add({ type: 'review_submitted', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      alert('Thank you for your feedback!');
      document.getElementById('starReview').value = '';
    }).catch(error => console.error("Error submitting review: ", error));
}
</script>


</body>
</html>